---
import { Image } from "astro:assets";
import { getCollection } from "astro:content";
import { slug } from "github-slugger";

const blogs = await getCollection("blogs");
var Categories: any = [];
blogs?.map(({ data: { category } }: any) => Categories.push(category));
const uniqueCategories: any = new Set(Categories);
---

<aside class='flex flex-col gap-y-8'>
  <!-- Categories Widget -->
  <div class='bg-gray-50 p-6 shadow-lg'>
    <div class='relative mb-6 pb-3'>
      <h3 class='font-InstrumentSans text-xl font-bold text-[#1C2C3B]'>
        Blog Categories
      </h3>
      <div class='absolute bottom-0 left-0 h-[2px] w-12 bg-[#f97316]'></div>
    </div>
    <ul class='space-y-3'>
      {
        Array.from(uniqueCategories, (category: string) => (
          <li class='border-b border-gray-200 pb-3 last:border-b-0 last:pb-0'>
            <button class='font-InstrumentSans text-gray-700 hover:text-[#f97316] transition-colors duration-300 flex items-center justify-between w-full'>
              <span>{category}</span>
              <span class='text-sm text-gray-500'>
                ({
                  blogs.filter((blog: any) => {
                    return blog?.data?.category === category;
                  }).length
                })
              </span>
            </button>
          </li>
        ))
      }
    </ul>
  </div>

  <!-- Recent Posts Widget -->
  <div class='bg-gray-50 p-6 shadow-lg'>
    <div class='relative mb-6 pb-3'>
      <h3 class='font-InstrumentSans text-xl font-bold text-[#1C2C3B]'>
        Recent Posts
      </h3>
      <div class='absolute bottom-0 left-0 h-[2px] w-12 bg-[#f97316]'></div>
    </div>
    <ul class='space-y-4'>
      {
        blogs
          .sort(
            (a, b) =>
              new Date(b.data.date).getTime() - new Date(a.data.date).getTime()
          )
          .slice(0, 3)
          .map(({ data: { title, image, date } }: any) => (
            <li class='group'>
              <div class='flex gap-4'>
                <a
                  href={`/blog/${slug(title)}`}
                  class='block w-20 h-16 overflow-hidden shrink-0'>
                  <Image
                    src={image}
                    alt={title}
                    width='80'
                    height='64'
                    class='w-full h-full object-cover hover:scale-105 transition-transform duration-300'
                  />
                </a>
                <div class='flex-1 min-w-0'>
                  <div class='flex items-center gap-2 mb-2 text-xs text-gray-500'>
                    <svg class='w-4 h-4' fill='none' stroke='currentColor' viewBox='0 0 24 24' xmlns='http://www.w3.org/2000/svg'>
                      <path stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z'></path>
                    </svg>
                    <span class='font-InstrumentSans'>{date}</span>
                  </div>
                  <a
                    href={`/blog/${slug(title)}`}
                    class='font-InstrumentSans text-sm font-semibold text-[#1C2C3B] hover:text-[#f97316] transition-colors duration-300 line-clamp-2 leading-tight'>
                    {title}
                  </a>
                </div>
              </div>
            </li>
          ))
      }
    </ul>
  </div>

  <!-- Newsletter Signup Widget -->
  <div class='bg-[#1C2C3B] p-6 text-center'>
    <h3 class='font-InstrumentSans text-xl font-bold text-white mb-4' id='newsletter-sidebar-title'>
      Stay Updated
    </h3>
    <p class='font-InstrumentSans text-gray-200 mb-6 text-sm' id='newsletter-sidebar-description'>
      Get the latest insights on business finance and growth strategies delivered to your inbox.
    </p>
    <form class='space-y-4 newsletter-sidebar-form' action='/api/newsletter-subscribe' method='POST'>
      <div>
        <label for='newsletter-sidebar-email' class='sr-only'>Email address for newsletter subscription</label>
        <input
          type='email'
          id='newsletter-sidebar-email'
          name='email'
          placeholder='Enter your email'
          required
          aria-labelledby='newsletter-sidebar-title'
          aria-describedby='newsletter-sidebar-description'
          class='w-full px-4 py-3 font-InstrumentSans text-sm focus:outline-none focus:ring-2 focus:ring-[#f97316]'
        />
      </div>
      <button
        type='submit'
        class='w-full bg-[#f97316] text-white px-4 py-3 font-InstrumentSans font-bold hover:bg-[#ea580c] hover:shadow-lg transition-all duration-300'>
        Subscribe Now
      </button>
    </form>
  </div>

  <!-- Quick Links Widget -->
  <div class='bg-gray-50 p-6 shadow-lg'>
    <div class='relative mb-6 pb-3'>
      <h3 class='font-InstrumentSans text-xl font-bold text-[#1C2C3B]'>
        Quick Links
      </h3>
      <div class='absolute bottom-0 left-0 h-[2px] w-12 bg-[#f97316]'></div>
    </div>
    <ul class='space-y-3'>
      <li>
        <a href='/finance-ready-assessment' class='font-InstrumentSans text-gray-700 hover:text-[#f97316] transition-colors duration-300 flex items-center gap-2'>
          <i class='fas fa-chart-line text-[#f97316]'></i>
          Finance Readiness Assessment
        </a>
      </li>
      <li>
        <a href='/success-stories' class='font-InstrumentSans text-gray-700 hover:text-[#f97316] transition-colors duration-300 flex items-center gap-2'>
          <i class='fas fa-trophy text-[#f97316]'></i>
          Success Stories
        </a>
      </li>
      <li>
        <a href='/about' class='font-InstrumentSans text-gray-700 hover:text-[#f97316] transition-colors duration-300 flex items-center gap-2'>
          <i class='fas fa-user-tie text-[#f97316]'></i>
          About Us
        </a>
      </li>
      <li>
        <a href='/contact' class='font-InstrumentSans text-gray-700 hover:text-[#f97316] transition-colors duration-300 flex items-center gap-2'>
          <i class='fas fa-phone text-[#f97316]'></i>
          Contact
        </a>
      </li>
    </ul>
  </div>
</aside>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const sidebarForm = document.querySelector('.newsletter-sidebar-form');
    
    if (sidebarForm) {
      sidebarForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const emailInput = this.querySelector('#newsletter-sidebar-email') as HTMLInputElement;
        const submitButton = this.querySelector('button[type="submit"]') as HTMLButtonElement;
        
        if (!emailInput || !submitButton) return;
        
        const email = emailInput.value.trim();
        
        if (!email) {
          alert('Please enter your email address.');
          return;
        }
        
        // Simple email validation
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        if (!emailRegex.test(email)) {
          alert('Please enter a valid email address.');
          return;
        }
        
        // Disable button and show loading state
        const originalText = submitButton.textContent;
        submitButton.disabled = true;
        submitButton.textContent = 'Subscribing...';
        
        // Get the current page path for source tracking
        const currentPath = window.location.pathname;
        
        fetch('/api/newsletter-subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: email,
            source: `${currentPath}_sidebar`
          })
        })
        .then(response => response.json())
        .then(result => {
          if (result.success) {
            alert('Thank you for subscribing! You\'ll receive your first newsletter soon.');
            emailInput.value = '';
          } else {
            alert(result.error || 'Something went wrong. Please try again.');
          }
        })
        .catch(error => {
          console.error('Newsletter subscription error:', error);
          alert('Unable to subscribe at this time. Please try again later.');
        })
        .finally(() => {
          submitButton.disabled = false;
          submitButton.textContent = originalText;
        });
      });
    }
  });
</script>
