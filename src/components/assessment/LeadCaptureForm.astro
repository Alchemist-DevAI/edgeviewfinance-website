---
export interface Props {
  score: number;
  level: string;
}

const { score, level } = Astro.props;
---

<div id="lead-capture" class="bg-white border-2 border-orange-500 p-6 sm:p-8 max-w-2xl mx-auto">
  <div class="text-center mb-8">
    <h3 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-4">
      Get Your Complete Finance Ready Package
    </h3>
    <p class="text-gray-600 text-lg">
      Detailed report plus exclusive resources - $1,035 value
    </p>
    <div class="inline-flex items-center px-4 py-2 bg-orange-100 text-orange-800 text-sm font-medium mt-4">
      <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 24 24">
        <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
      </svg>
      Your Score: {score}/50 - {level}
    </div>
  </div>

  <!-- Value Stack Reminder -->
  <div class="bg-gray-50 p-6 mb-8">
    <h4 class="font-semibold text-gray-900 mb-4">Here's everything in your complete package:</h4>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
      <div class="flex items-start">
        <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>Personalised Finance Readiness Report (PDF)</span>
      </div>
      <div class="flex items-start">
        <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>Custom Action Checklist for Your Score Level</span>
      </div>
      <div class="flex items-start">
        <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>Finance Ready Lending Playbook</span>
      </div>
      <div class="flex items-start">
        <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>Business Debt Servicing Calculator (Excel)</span>
      </div>
      <div class="flex items-start">
        <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>7-Day Email Course: Days to Finance Ready</span>
      </div>
      <div class="flex items-start">
        <svg class="w-4 h-4 text-green-500 mr-2 mt-0.5 flex-shrink-0" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        <span>Application Timeline Template</span>
      </div>
    </div>
  </div>

  <!-- Form -->
  <form id="lead-capture-form" class="space-y-6">
    <div>
      <label for="email" class="block text-sm font-medium text-gray-700 mb-2">
        Email Address *
      </label>
      <input
        type="email"
        id="email"
        name="email"
        required
        placeholder="your@email.com"
        class="w-full px-4 py-3 border border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-500 focus:ring-opacity-20 transition-colors"
      />
    </div>
    
    <div>
      <label for="business_name" class="block text-sm font-medium text-gray-700 mb-2">
        Business Name
      </label>
      <input
        type="text"
        id="business_name"
        name="business_name"
        placeholder="Your Business Pty Ltd"
        class="w-full px-4 py-3 border border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-500 focus:ring-opacity-20 transition-colors"
      />
    </div>
    
    <div>
      <label for="phone" class="block text-sm font-medium text-gray-700 mb-2">
        Phone Number
      </label>
      <input
        type="tel"
        id="phone"
        name="phone"
        placeholder="0400 000 000"
        class="w-full px-4 py-3 border border-gray-300 focus:border-orange-500 focus:ring-2 focus:ring-orange-500 focus:ring-opacity-20 transition-colors"
      />
    </div>

    <!-- Loading state -->
    <div id="form-loading" class="hidden text-center py-4">
      <div class="inline-flex items-center">
        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-orange-500 mr-2"></div>
        <span class="text-gray-600">Sending your package...</span>
      </div>
    </div>

    <!-- Error state -->
    <div id="form-error" class="hidden bg-red-50 border border-red-200 p-4 text-red-700 text-sm">
      <p>There was an error sending your package. Please try again or contact us directly.</p>
    </div>
  
    <button
      type="submit"
      id="submit-btn"
      class="w-full py-4 px-6 bg-gradient-to-r from-orange-500 to-orange-600 text-white font-semibold text-lg hover:shadow-lg transform hover:scale-[1.02] transition-all duration-300"
    >
      Send My $1,035 Package Now
    </button>
    
    <p class="text-xs text-gray-500 text-center">
      Instant access - check your email in 2 minutes
    </p>
  </form>
  
  <!-- Privacy Notice -->
  <div class="mt-6 pt-6 border-t border-gray-200">
    <div class="flex flex-wrap gap-4 justify-center text-xs text-gray-500">
      <div class="flex items-center">
        <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 15v2m-6 4h12a2 2 0 002-2v-9a2 2 0 00-2-2H6a2 2 0 00-2 2v9a2 2 0 002 2zm10-12V6a4 4 0 00-8 0v3h8z"/>
        </svg>
        Your information is 100% secure and confidential
      </div>
      <div class="flex items-center">
        <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
        </svg>
        We respect your privacy - never shared with third parties
      </div>
      <div class="flex items-center">
        <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 24 24">
          <path d="M6 18L18 6M6 6l12 12"/>
        </svg>
        Unsubscribe anytime with one click
      </div>
    </div>
  </div>
</div>

<script>
  import { supabase } from '../../lib/supabase.js';
  
  // Handle form submission
  document.getElementById('lead-capture-form')?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target as HTMLFormElement);
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const loadingDiv = document.getElementById('form-loading');
    const errorDiv = document.getElementById('form-error');
    
    // Show loading state
    submitBtn.disabled = true;
    submitBtn.textContent = 'Sending Package...';
    loadingDiv?.classList.remove('hidden');
    errorDiv?.classList.add('hidden');
    
    try {
      // Get assessment data from session storage
      const assessmentData = JSON.parse(sessionStorage.getItem('assessmentData') || '{}');
      
      // Prepare data for Supabase
      const data = {
        email: formData.get('email') as string,
        business_name: formData.get('business_name') as string,
        phone: formData.get('phone') as string,
        q1_financial_management: assessmentData.q1 || null,
        q2_revenue_profile: assessmentData.q2 || null,
        q3_asset_visibility: assessmentData.q3 || null,
        q4_documentation_checklist: assessmentData.q4 || 0,
        q5_application_experience: assessmentData.q5 || null,
        total_score: assessmentData.score || 0,
        readiness_level: assessmentData.level || '',
        utm_source: new URLSearchParams(window.location.search).get('utm_source') || null,
        utm_medium: new URLSearchParams(window.location.search).get('utm_medium') || null,
        utm_campaign: new URLSearchParams(window.location.search).get('utm_campaign') || null,
        referrer_url: document.referrer || null,
        email_sent: false,
        consultation_booked: false,
        instantly_webhook_sent: false
      };
      
      // Store in Supabase
      const { error } = await supabase
        .from('assessment_responses')
        .insert([data]);
      
      if (error) {
        throw error;
      }
      
      // Send to Instantly.ai webhook (placeholder)
      await sendToInstantly(data);
      
      // Success - redirect to thank you page
      sessionStorage.setItem('leadCaptured', 'true');
      window.location.href = '/finance-ready-assessment/thank-you';
      
    } catch (error) {
      console.error('Error submitting form:', error);
      
      // Show error state
      loadingDiv?.classList.add('hidden');
      errorDiv?.classList.remove('hidden');
      submitBtn.disabled = false;
      submitBtn.textContent = 'Send My $1,035 Package Now';
    }
  });
  
  async function sendToInstantly(data: any) {
    // Placeholder for Instantly.ai integration
    // Will be activated when API key is provided
    console.log('Would send to Instantly.ai:', data);
    
    // When ready:
    // const INSTANTLY_WEBHOOK_URL = import.meta.env.INSTANTLY_WEBHOOK_URL;
    // if (INSTANTLY_WEBHOOK_URL) {
    //   await fetch(INSTANTLY_WEBHOOK_URL, {
    //     method: 'POST',
    //     headers: {
    //       'Content-Type': 'application/json',
    //       'X-API-Key': import.meta.env.INSTANTLY_API_KEY || ''
    //     },
    //     body: JSON.stringify({
    //       email: data.email,
    //       custom_fields: {
    //         score: data.total_score,
    //         level: data.readiness_level,
    //         business_name: data.business_name,
    //         phone: data.phone
    //       }
    //     })
    //   });
    // }
  }
</script>